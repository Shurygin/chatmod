<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru">
<head>
    <title>Тест Чата</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

</head>
<body>
<h1>Проверка чата</h1>

<script>
    (function(w,d,u){
        var s=d.createElement('script');s.async=true;s.src=u+'?'+(Date.now()/60000|0);
        var h=d.getElementsByTagName('script')[0];h.parentNode.insertBefore(s,h);
    })(window,document,'https://bitrixold.alean.ru/upload/crm/site_button/loader_1_i6vdg7.js');
</script>


<div class="alean-bx24-chat-wrapper">

    <div  class="alean-bx24-chat-button" >Чат с менеджером</div>
    <div class="alean-bx24-chat-gif"></div>
</div>




<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function(){
        var gifImage = document.getElementsByClassName('alean-bx24-chat-gif')[0];
        gifImage.style.height='32px';
        gifImage.style.width='32px';
        gifImage.style.display='none';
        gifImage.style.background="center url(https://gitlab.com/teamfirstbit/alean/" +
            "uploads/68584e5fc94c070684892dfe1d11a07e/CHAT_new_messages.gif) no-repeat";
        let interv = setInterval(function () {
            if (document.getElementsByClassName('b24-widget-button-block').length > 0) {
                clearInterval(interv);
                document.getElementsByClassName('b24-widget-button-block')[0].addEventListener('click', function () {
                    let intervalCount = 0;
                    let clientName = 'Aleksey';
                    let clientEmail = 'magnito13@yandex.ru';
                    let clientPhone = '';
                    clientPhone = clientPhone.length?clientPhone.match(/[0-9]/g).join(''):clientPhone;
                    let TANumber = '123456';
                    let evt = document.createEvent("HTMLEvents");
                    evt.initEvent("input", false, true);
                    let eventListenerAdded = false;
                    let eventListenerAddedOnSelect = false;
                    let formSent = false;
                    let clicked = false;
                    if (!clicked) {
                        clicked = true;
                        let interval1 = setInterval(function () {
                            if (document.getElementsByClassName('bx-im-textarea-input').length > 0) {
                                clearInterval(interval1);
                                if (!eventListenerAdded) {
                                    eventListenerAdded = true;
                                    if (document.getElementsByClassName('bx-input-select').length === 0) {
                                        let isTA = true;
                                        let inputTheme = '';
                                        if (isTA) {
                                            document.getElementsByClassName('bx-im-textarea-input')[0].setAttribute('disabled', 'disabled');
                                            document.getElementsByClassName('bx-im-textarea-input')[0].setAttribute('placeholder', 'Выберите тему обращения вверху чата');
                                            inputTheme = '<select class="ui-ctl-element bx-input-select" style="height:auto"size="5" name="theme">' +
                                                '<option disabled >Выберите тему обращения</option>' +
                                                '<option value="Внести изменения в заявку">Внести изменения в заявку</option>' +
                                                '<option value="Аннулировать заявку">Аннулировать заявку</option>' +
                                                '<option value="Отдел оплат">Отдел оплат</option>' +
                                                '<option value="Другое">Другое</option>' +
                                                '</select>';
                                        }
                                        if (inputTheme.length > 0) {
                                            document.getElementsByClassName('bx-livechat-head')[0].insertAdjacentHTML('afterEnd', inputTheme);
                                            if (!eventListenerAddedOnSelect) {
                                                eventListenerAddedOnSelect = true;
                                                document.getElementsByClassName('bx-input-select')[0].addEventListener('change', function () {
                                                    document.getElementsByClassName('bx-input-select')[0].setAttribute('size', '1');
                                                    document.getElementsByClassName('bx-im-textarea-input')[0].removeAttribute('disabled');
                                                    document.getElementsByClassName('bx-im-textarea-input')[0].setAttribute('placeholder', 'Введите сообщение');
                                                    let text = 'Тема обращения: ' + document.getElementsByClassName('bx-input-select')[0].value;
                                                    document.getElementsByTagName('textarea')[0].value = text;
                                                    document.getElementsByTagName('textarea')[0].dispatchEvent(evt);
                                                    let interval2 = setInterval(function () {
                                                        if (document.getElementsByClassName('bx-im-textarea-send-button').length > 0) {
                                                            let themeSent = false;
                                                            if (!themeSent) {
                                                                clearInterval(interval2);
                                                                themeSent = true;
                                                                document.getElementsByClassName('bx-im-textarea-send-button')[0].click();
                                                            }
                                                        }
                                                    }, 10);

                                                });
                                            }
                                        }
                                    }
                                    document.getElementsByClassName('bx-im-textarea-input')[0].addEventListener('input', function () {
                                        let interval = setInterval(function () {
                                            if (document.getElementsByClassName('ui-ctl-element').length > 1) {
                                                clearInterval(interval);
                                                if (!formSent) {
                                                    formSent = true;
                                                    for (let j = 1; j < document.getElementsByClassName('ui-ctl-element').length; j++) {
                                                        let plh = document.getElementsByClassName('ui-ctl-element')[j].placeholder;
                                                        switch (plh) {
                                                            case 'Имя':
                                                                document.getElementsByClassName('ui-ctl-element')[j].value = clientName;
                                                                break;
                                                            case 'Электронная почта':
                                                                if (clientEmail.length>0)
                                                                {
                                                                    document.getElementsByClassName('ui-ctl-element')[j].value = clientEmail;
                                                                }
                                                                break;
                                                            case 'Номер телефона':
                                                                if (clientPhone.length>0)
                                                                {
                                                                    document.getElementsByClassName('ui-ctl-element')[j].value = clientPhone;
                                                                }
                                                                break;
                                                        }
                                                        document.getElementsByClassName('ui-ctl-element')[j].dispatchEvent(evt);
                                                    }
                                                    document.getElementsByClassName('bx-livechat-btn-success')[0].click();
                                                    let textTA = 'Номер договора с ТА: ' + TANumber;
                                                    document.getElementsByTagName('textarea')[0].value = textTA;
                                                    document.getElementsByTagName('textarea')[0].dispatchEvent(evt);
                                                    let interval3 = setInterval(function () {
                                                        if (document.getElementsByClassName('bx-im-textarea-send-button').length > 0) {
                                                            let TASent = false;
                                                            if (!TASent) {
                                                                clearInterval(interval3);
                                                                TASent = true;
                                                                document.getElementsByClassName('bx-im-textarea-send-button')[0].click();
                                                            }
                                                        }
                                                    }, 10);
                                                }
                                            }
                                            intervalCount++;
                                            if (intervalCount > 6000) {
                                                console.log('cleared');
                                                clearInterval(interval);
                                            }
                                        }, 10);
                                    });
                                }
                            }
                        }, 10);
                    }
                });
                function showUnreadMessageGif() {
                    document.getElementsByClassName('alean-bx24-chat-gif')[0].style.display = 'block';
                }
                var wrapper = document.getElementsByClassName('alean-bx24-chat-wrapper')[0];
                document.getElementsByTagName("body")[0].append(wrapper);
                document.getElementsByClassName('b24-widget-button-wrapper')[0].style.display = 'none';
                var counterForDialog=0;
                var intervalForDialogWindow = setInterval(function(){
                    counterForDialog++;
                    if (document.getElementsByClassName('bx-livechat-wrapper').length > 0) {
                        clearInterval(intervalForDialogWindow);
                        document.getElementsByClassName('bx-livechat-wrapper')[0].parentElement.classList.add('div-with-chat-window');
                        document.getElementsByClassName('div-with-chat-window')[0].style.position = 'fixed';
                        document.getElementsByClassName('div-with-chat-window')[0].style.top = '150px';
                        document.getElementsByClassName('div-with-chat-window')[0].style.left = '450px';
                        document.getElementsByClassName('bx-livechat-wrapper')[0].style.position = 'relative';
                        document.getElementsByClassName('div-with-chat-window')[0].style.display = 'none';
                        var intervalForGif = setInterval(function(){
                            if (document.getElementsByClassName('bx-im-dialog-scroll-button-counter-digit').length > 0) {
                                clearInterval(intervalForGif);
                                if (parseInt(document.getElementsByClassName('bx-im-dialog-scroll-button-counter-digit')[0].textContent) > 0) {
                                    showUnreadMessageGif();
                                }
                            }
                        },10);
                    } else if (counterForDialog>100) {
                        clearInterval(intervalForDialogWindow);
                    }
                },10);



                function addDomeMutationListener() {
                    var targetNode = document.getElementsByClassName('bx-im-dialog-list-box')[0];
                    var config = { attributes: true, childList: true, subtree: true };
                    var callback = function (mutationsList, observer) {
                        for (var mutation of mutationsList) {
                            if (mutation.addedNodes !== undefined) {
                                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                                    if (mutation.addedNodes[0].classList.length === 5) {
                                        if (document.getElementsByClassName('bx-livechat-wrapper')[0].parentElement.style.display === 'none' &&
                                            document.getElementsByClassName('alean-bx24-chat-gif')[0].style.display === 'none'
                                        ) {
                                            showUnreadMessageGif();
                                        }
                                    }
                                }
                            }
                        }
                    };
                    observer = new MutationObserver(callback);
                    observer.observe(targetNode, config);
                }
                if (document.getElementsByClassName('bx-im-textarea-input').length > 0) {
                    addDomeMutationListener();
                }
                document.getElementsByClassName('alean-bx24-chat-button')[0].addEventListener('click', function () {
                    document.getElementsByClassName('alean-bx24-chat-gif')[0].style.display = 'none';
                    if (document.getElementsByClassName('bx-livechat-wrapper').length > 0) {
                        if (document.getElementsByClassName('div-with-chat-window')[0].style.display === 'block') {
                            document.getElementsByClassName('div-with-chat-window')[0].style.display = 'none';
                            addDomeMutationListener();
                        } else {
                            document.getElementsByClassName('div-with-chat-window')[0].style.display = 'block';
                        }
                    } else {
                        document.getElementsByClassName('b24-widget-button-block')[0].click();
                        var intervalForClick =  setInterval(function(){
                            if (document.getElementsByClassName('bx-livechat-wrapper').length>0){
                                clearInterval(intervalForClick);
                                document.getElementsByClassName('bx-livechat-wrapper')[0].parentElement.classList.add('div-with-chat-window');
                                document.getElementsByClassName('div-with-chat-window')[0].style.position = 'fixed';
                                document.getElementsByClassName('div-with-chat-window')[0].style.top = '150px';
                                document.getElementsByClassName('div-with-chat-window')[0].style.left = '450px';
                                document.getElementsByClassName('bx-livechat-wrapper')[0].style.position = 'relative';
                            }
                        },10);
                    }
                });
            }
        }, 10);
    });
</script>
</body>
</html>
